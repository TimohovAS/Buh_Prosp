# ProspEl — Подробное описание работы программы

## Версия 2.0 (ПАКЕТ 1 — Миграции и модели)

- **Income:** `issued_date` (alias колонки `date`), `status` (issued|paid|cancelled), `project_id`, `income_type` (advance|intermediate|final|other). Старые записи: status='paid' если paid_date есть, иначе 'issued'.
- **Expenses:** `paid_date`, `status` (planned|paid|reversed), `is_tax_related`, `source` (manual|planned|obligation|bank_import), `reversed_expense_id`, `reversal_of_id` — сторно вместо удаления.
- **period_closures:** таблица для закрытия периодов (year, month, closed_at, closed_by_user_id).
- **Запрет удаления:** расходы из obligation и bank_import не удаляются физически — создаётся сторно (reversal).

## ПАКЕТ 2 — Сторно расхода

- **PATCH /api/expenses/{id}/reverse** — явное сторно расхода. Body: `{ "date": "YYYY-MM-DD", "comment": "optional" }`. Создаётся запись с `amount = -original.amount`, `status=reversed`, `reversal_of_id=original.id`. Оригинал остаётся `status=paid`, получает `reversed_expense_id`.
- **mark-unpaid** (обязательства, планируемые расходы): вместо удаления вызывается сторно; оригинал не удаляется.
- **DELETE /expenses/{id}**: всегда создаётся сторно, физическое удаление отсутствует.
- Отчёты: `sum(Expense.amount)` учитывает сторно (отрицательные суммы).

## ПАКЕТ 3 — Финансовый сервис

- **finance_service.get_finance_summary** — агрегатор метрик accrual/cash.
- Метрики: revenue_accrual, revenue_cash, expense_accrual, expense_cash, taxes_cash, net_profit_accrual, net_profit_cash.
- Группировка: day (YYYY-MM-DD), month (YYYY-MM), year (YYYY).
- Фильтры: client_id, contract_id, project_id (incomes), category, is_tax_related (expenses).
- **GET /api/finance/summary** — query: from, to, group_by, mode; optional: client_id, contract_id, project_id, category, is_tax_related. Response: range, series, totals.
- **GET /api/finance/ar** — дебиторка: unpaid incomes (paid_date is null). Поля: income_id, invoice_number, client_name, issued_date, amount, days_outstanding. totals: ar_total, ar_overdue (>30 дн.).
- **PATCH /api/income/{id}/mark-paid** — body: { paid_date }. income.paid_date=paid_date, status='paid'. Влияет на AR и revenue_cash.

---

## 1. Общие сведения

**ProspEl** — бухгалтерская система для индивидуального предпринимателя (ИП) на паушальном режиме налогообложения в Республике Сербия. Программа ведёт учёт доходов, расходов, обязательных платежей (налоги и взносы), планируемых расходов и предоставляет отчёты в формате, соответствующем требованиям Пореске управе (налоговая служба Сербии).

### Архитектура

- **Backend:** FastAPI (Python 3.10+), асинхронная работа с БД через SQLAlchemy
- **Frontend:** React (Vite), SPA-интерфейс
- **База данных:** SQLite по умолчанию, возможна замена на PostgreSQL
- **Аутентификация:** JWT-токены, bcrypt для хеширования паролей

---

## 2. Структура интерфейса

После входа пользователь видит боковое меню со следующими разделами:

| Раздел | Описание |
|--------|----------|
| **Панель** | Главная страница со сводными показателями |
| **Доходы (КПО)** | Книга прихода и расхода — учёт доходов |
| **Клиенты** | Справочник контрагентов |
| **Договоры** | Управление договорами с позициями |
| **Расходы** | Учёт фактических расходов |
| **Планируемые расходы** | Периодические расходы (аренда, коммуналка и т.п.) |
| **Импорт выписки** | Загрузка банковских транзакций из Excel |
| **Налоги и взносы** | Обязательные платежи Пореске управе |
| **Настройки** | Предприятие, пользователи, язык |

Интерфейс доступен на **сербском** и **русском** языках. Переключатель языка в боковой панели.

---

## 3. Аутентификация и пользователи

### Роли

- **admin** — полный доступ, управление пользователями и предприятием
- **accountant** — бухгалтер, полный учётный доступ
- **cashier** — кассир
- **observer** — только просмотр

Учётные данные по умолчанию: `admin` / `admin`.

### Авторизация

- Вход по логину и паролю, получение JWT
- Токен сохраняется в localStorage, передаётся в заголовке `Authorization`
- Для защищённых маршрутов требуется валидный токен

---

## 4. Главная панель (Dashboard)

На панели отображаются:

1. **Баланс за месяц** — разница между доходами и расходами за текущий месяц
2. **Баланс за год** — то же за календарный год
3. **Планируемые расходы до конца месяца** — сумма планируемых и обязательных платежей с дедлайном до конца текущего месяца
4. **Круговые диаграммы** — соотношение доходов и расходов за месяц и за год
5. **Лимиты паушального режима:**
   - 6 млн RSD в год — превышение влечёт переход на общий режим
   - 8 млн RSD за 12 месяцев — превышение требует регистрации НДС
6. **Предупреждение о платежах** — список просроченных и приближающихся обязательных платежей (налоги, взносы)
7. **Последние доходы** — таблица недавних записей КПО

---

## 5. Доходы (Книга прихода и расхода — КПО)

- Записи с датой, номером счёта, клиентом, описанием, суммой
- Связь с договором и типом платежа (аванс, промежуточный, закрывающий)
- Генерация следующего номера счёта (формат `YYYY-NNNN`)
- Предупреждение о дублировании номера счёта
- Экспорт в **CSV** и **PDF** для отчётности

---

## 6. Клиенты

- Хранение: название, адрес, PIB (налоговый номер), контакт, тип (юр. лицо / физ. лицо)
- Архивация (деактивация без удаления)
- Поиск по названию и параметрам

---

## 7. Договоры

- Номер, дата, клиент, предмет, сумма, сроки действия
- Типы: услуги, поставка, аренда, комиссия
- Позиции договора: описание, количество, цена
- Статусы: активен, завершён, расторгнут
- Связь с доходами — при создании дохода можно указать договор и тип платежа

---

## 8. Расходы

- Дата, описание, сумма, категория (материалы, услуги, аренда, прочее, налог)
- Фильтрация по году и месяцу
- Автоматическое создание записей при:
  - оплате планируемого расхода
  - оплате обязательного платежа (налог, PIO и т.д.)
  - импорте банковской выписки

---

## 9. Планируемые расходы

Периодические расходы с настраиваемым периодом:

- **Периоды:** еженедельно, ежемесячно, ежеквартально, ежегодно
- **Параметры:** день уплаты, даты начала/окончания, напоминание
- **Категории:** аренда, интернет, телефон, коммуналка, страхование, ПО, прочее

### Предстоящие платежи

- Список планируемых платежей на выбранный период (30, 60 или 90 дней)
- Выбор периода сохраняется в localStorage
- Для каждого платежа: отметить «оплачено» (создаётся запись в Расходах) или отменить оплату (запись удаляется; для obligation/bank_import — сторно)

---

## 10. Импорт банковской выписки

- Загрузка файла `.xls` / `.xlsx` с транзакциями
- Разбор выписки, сопоставление с клиентами и номерами счетов
- Отметка транзакций как доход или расход
- Массовый импорт выбранных транзакций

---

## 11. Налоги и взносы

Модуль обязательных платежей Пореске управе (налоговая служба Сербии).

### Типы платежей

- **Порез на приход** — налог на доход
- **PIO** — допринос за ПИО (пенсионное страхование)
- **Здравствено осигурање** — медицинское страхование
- **Незапосленост** — страхование на случай безработицы

### Решения (YearDecision)

Для каждого года и типа платежа задаются:

- Период (начало–конец)
- Месячная сумма
- Реквизиты: рачун примаоца, шифра плаћања, модель, позив на број
- Сврха уплате (шаблон с подстановкой года)
- Флаг «привремене аконтације» (предварительные взносы)

### Календарь обязательств

- Для каждого месяца создаются обязательства (MonthlyObligation) на основе решений
- **Дедлайн** — строго 15-е число месяца, следующего за отчётным (напр. аконт. за январь — доспева 15.02)
- Статусы: `unpaid`, `paid`, `overdue`

### Операции

- **Отметить оплаченным** — ввод даты оплаты и номера платёжного поручения; автоматически создаётся запись в Расходах
- **Отменить отметку** — обязательство снова становится неоплаченным; связанная запись в Расходах удаляется
- **IPS QR** — данные для генерации QR-кода по стандарту NBS (Национална банка Србије)

### Пресет 2026

- Кнопка «Применить пресет 2026» — создаёт решения для Пореза и PIO с суммами и реквизитами по ТЗ

---

## 12. Настройки

### Предприятие

- Название, адрес, PIB, матични број, банковские реквизиты, шифра делатности

### Пользователи (только для admin)

- Добавление, редактирование, деактивация пользователей
- Роли, язык по умолчанию
- Нельзя деактивировать себя

---

## 13. База данных

### Основные таблицы

| Таблица | Назначение |
|---------|------------|
| `users` | Пользователи системы |
| `clients` | Клиенты |
| `enterprise` | Данные предприятия |
| `contracts` | Договоры |
| `contract_items` | Позиции договоров |
| `income` | Книга доходов (КПО) |
| `expenses` | Расходы |
| `planned_expenses` | Планируемые расходы |
| `planned_expense_payments` | Отметки об оплате планируемых расходов |
| `payment_types` | Типы обязательных платежей |
| `year_decisions` | Решения Пореске управе на год |
| `monthly_obligations` | Месячные обязательства (налог, PIO и т.д.) |

### Миграции

При запуске выполняются проверки и добавляются недостающие колонки (например, `expense_id` в `monthly_obligations`, `bank_reference` в `expenses`).

---

## 14. API (основные эндпоинты)

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/api/auth/login` | Вход, получение JWT |
| GET | `/api/dashboard` | Данные панели |
| GET/POST | `/api/income` | Список и создание доходов |
| GET/POST | `/api/clients` | Клиенты |
| GET/POST | `/api/contracts` | Договоры |
| GET/POST | `/api/expenses` | Расходы |
| GET | `/api/planned-expenses` | Планируемые расходы |
| GET | `/api/planned-expenses/upcoming` | Предстоящие платежи |
| POST | `/api/planned-expenses/mark-paid` | Отметить планируемый платёж оплаченным |
| POST | `/api/planned-expenses/mark-unpaid` | Отменить отметку |
| GET | `/api/obligations/types` | Типы платежей |
| GET | `/api/obligations/calendar` | Календарь обязательств |
| GET/POST/PATCH | `/api/obligations/decisions` | Решения |
| POST | `/api/obligations/decisions/apply-preset-2026` | Применить пресет 2026 |
| PATCH | `/api/obligations/obligations/{id}/mark-paid` | Отметить обязательство оплаченным |
| PATCH | `/api/obligations/obligations/{id}/mark-unpaid` | Отменить отметку |
| GET | `/api/obligations/obligations/{id}/ips-qr` | Данные для IPS QR |
| POST | `/api/bank-import/parse` | Разбор выписки |
| POST | `/api/bank-import/apply` | Импорт транзакций |
| GET | `/api/reports/kpo/csv` | Экспорт КПО в CSV |
| GET | `/api/reports/kpo/pdf` | Экспорт КПО в PDF |

---

## 15. Конфигурация

Файл `.env` (опционально):

- `DATABASE_URL` — подключение к БД (по умолчанию SQLite: `prospel.db`)
- `SECRET_KEY` — ключ для JWT
- `INCOME_LIMIT_PAUSAL` — лимит 6 млн RSD
- `INCOME_LIMIT_VAT` — лимит 8 млн RSD
- `LIMIT_WARNING_PERCENT` — порог предупреждения (например, 80%)

---

## 16. Установка и запуск

**Backend:**
```bash
python -m venv venv
venv\Scripts\activate
pip install -r requirements.txt
python run.py
```

**Frontend:**
```bash
cd frontend
npm install
npm run dev
```

Backend: http://127.0.0.1:8000  
Frontend: http://localhost:5173
